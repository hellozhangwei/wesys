<?xml version="1.0" encoding="UTF-8"?>
<!--
This software is in the public domain under CC0 1.0 Universal plus a 
Grant of Patent License.

To the extent possible under law, the author(s) have dedicated all
copyright and related and neighboring rights to this software to the
public domain worldwide. This software is distributed without any
warranty.

You should have received a copy of the CC0 Public Domain Dedication
along with this software (see the LICENSE.md file). If not, see
<http://creativecommons.org/publicdomain/zero/1.0/>.
-->
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.1.xsd"
        default-menu-title="Customer" default-menu-index="1">

    <parameter name="partyId" required="true"/>

    <transition name="findOrder"><default-response url="//${appRoot}/SalesOrder/SalesOrderFind"/></transition>
    <transition name="findShipment"><default-response url="//${appRoot}/Shipment/FindShipment"/></transition>
    <transition name="findRequest"><default-response url="//${appRoot}/Request/FindRequest"/></transition>

    <transition-include name="searchPartyList" location="component://SimpleScreens/template/party/PartyForms.xml"/>

    <transition name="updateParty"><service-call name="mantle.party.PartyServices.update#PartyDetail"/>
        <default-response url="."/></transition>

    <transition name="createPartyRole"><service-call name="create#mantle.party.PartyRole"/><default-response url="."/></transition>
    <transition name="deletePartyRole"><service-call name="delete#mantle.party.PartyRole"/><default-response url="."/></transition>

    <transition-include name="setPartyClassification" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty.xml"/>
    <transition-include name="removePartyClassification" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty.xml"/>
    <transition-include name="getPartyClassificationList" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty.xml"/>

    <transition-include name="storePartySetting" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty.xml"/>
    <transition-include name="deletePartySetting" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty.xml"/>
    <transition-include name="getPartySettingList" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty.xml"/>

    <transition name="createPartyIdentification"><service-call name="create#mantle.party.PartyIdentification"/>
        <default-response url="."/></transition>
    <transition name="updatePartyIdentification"><service-call name="update#mantle.party.PartyIdentification"/>
        <default-response url="."/></transition>
    <transition name="deletePartyIdentification"><parameter name="partyIdTypeEnumId"/>
        <service-call name="delete#mantle.party.PartyIdentification"/><default-response url="."/></transition>

    <transition name="createUserAccount"><service-call name="mantle.party.PartyServices.create#PartyUserAccount"/>
        <default-response url="."/></transition>
    <transition name="updateUserAccount"><service-call name="mantle.party.PartyServices.update#PartyUserAccount"/>
        <default-response url="."/></transition>
    <transition name="enableUserAccount"><service-call name="org.moqui.impl.UserServices.enable#UserAccount"/>
        <default-response url="."/></transition>
    <transition name="disableUserAccount"><service-call name="org.moqui.impl.UserServices.disable#UserAccount"/>
        <default-response url="."/></transition>
    <transition name="resetPassword"><service-call name="org.moqui.impl.UserServices.reset#Password"/>
        <default-response url="."/></transition>

    <transition name="createPartyRelationship"><service-call name="create#mantle.party.PartyRelationship"/>
        <default-response url="."/></transition>
    <transition name="updatePartyRelationship"><service-call name="update#mantle.party.PartyRelationship"/>
        <default-response url="."/></transition>
    <transition name="addContact"><service-call name="mantle.sales.AccountServices.add#Contact"/>
        <default-response url="."/></transition>
    <transition name="createContact"><service-call name="mantle.sales.AccountServices.create#Contact"/>
        <default-response url="."/></transition>
    <transition name="removeContact"><service-call name="mantle.sales.AccountServices.delete#Contact" in-map="[partyRelationshipId:partyRelationshipId]"/>
        <default-response url="."/></transition>

    <transition name="updatePaymentMethodInfo"><default-response url="UpdatePaymentMethodInfo"/></transition>
    <transition name="removePaymentMethod"><service-call name="mantle.account.PaymentMethodServices.delete#PaymentMethod"/>
        <default-response url="."/></transition>
    <transition name="editPaymentMethod"><default-response url="../PaymentMethod/EditPaymentMethod"/></transition>
    <transition name="findFinancialAccount"><default-response url="//${appRoot}/Accounting/FinancialAccount/FindFinancialAccount"/></transition>
    <transition name="editFinancialAccount"><default-response url="//${appRoot}/Accounting/FinancialAccount/EditFinancialAccount"/></transition>

    <transition name="storePartyContactMech"><service-call name="mantle.party.ContactServices.store#PartyContactMech"/>
        <default-response url="."/></transition>
    <transition name="removeContactInfo"><service-call name="mantle.party.ContactServices.delete#PartyContactMech"/>
        <default-response url="."/></transition>
    <transition name="updateContactMechMutable"><service-call name="mantle.party.ContactServices.update#ContactMechMutable"/>
        <default-response url="."/></transition>
    <transition name="validateAddress"><service-call name="mantle.shipment.CarrierServices.validate#PostalAddress"/>
        <default-response url="."/></transition>

    <transition name="createContactMechOther"><service-call name="mantle.party.ContactServices.create#ContactMechOther"/>
        <default-response url="."/></transition>
    <transition name="updatePartyContactOther"><service-call name="mantle.party.ContactServices.update#PartyContactOther"/>
        <default-response url="."/></transition>
    <transition-include name="getContactMechPurposesByType" location="component://SimpleScreens/template/party/PartyForms.xml"/>

    <transition name="createPartyNote"><service-call name="create#mantle.party.PartyNote"/><default-response url="."/></transition>
    <transition name="updatePartyNote"><service-call name="update#mantle.party.PartyNote"/><default-response url="."/></transition>

    <transition-include name="createContent" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty.xml"/>
    <transition-include name="updateContent" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty.xml"/>
    <transition-include name="downloadContent" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty.xml"/>

    <transition name="receivableStatement">
        <default-response url="${ec.web.getWebappRootUrl(false, null)}/fop/apps/${appRoot}/Accounting/Invoice/ReceivableStatement" url-type="plain">
            <parameter name="renderMode" value="xsl-fo"/><parameter name="pageNoLimit" value="true"/>
            <parameter name="toPartyId"/><parameter name="filename" value="Statement-${toPartyId}-${ec.l10n.format(ec.user.nowTimestamp, 'yyyy-MM-dd')}.pdf"/>
        </default-response>
    </transition>

    <subscreens>
        <subscreens-item name="UpdateContactInfo" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty/UpdateContactInfo.xml"/>
        <subscreens-item name="ExpiredContactOther" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty/ExpiredContactOther.xml"/>
        <subscreens-item name="ExpiredPostal" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty/ExpiredPostal.xml"/>
        <subscreens-item name="UpdatePaymentMethodInfo" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty/UpdatePaymentMethodInfo.xml"/>
        <subscreens-item name="FindDuplicates" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty/FindDuplicates.xml"/>
    </subscreens>

    <actions>
        <entity-find-one entity-name="mantle.party.PartyDetail" value-field="party"/>
        <if condition="party == null"><return error="true" message="Customer not found with ID ${partyId}"/></if>

        <!-- FUTURE: support multiple UserAccount records for partyId, for now just get non-disabled first and order by userId for consistency -->
        <entity-find entity-name="moqui.security.UserAccount" list="userAccountList">
            <econdition field-name="partyId"/>
            <econdition field-name="disabled" operator="not-equals" value="Y" or-null="true"/>
            <order-by field-name="userId"/>
        </entity-find>
        <if condition="!userAccountList">
            <entity-find entity-name="moqui.security.UserAccount" list="userAccountList">
                <econdition field-name="partyId"/>
                <econdition field-name="disabled" value="Y"/>
                <order-by field-name="userId"/>
            </entity-find>
        </if>
        <set field="userAccount" from="userAccountList ? userAccountList[0] : null"/>

        <entity-find-count entity-name="mantle.request.RequestAndParty" count-field="requestCount">
            <date-filter/><econdition field-name="partyId"/></entity-find-count>
        <entity-find-count entity-name="mantle.order.OrderPart" count-field="customerOrderPartCount">
            <econdition field-name="customerPartyId" from="partyId"/></entity-find-count>
        <entity-find-count entity-name="mantle.shipment.Shipment" count-field="toShipmentCount">
            <econdition field-name="toPartyId" from="partyId"/></entity-find-count>

        <entity-find entity-name="mantle.party.PartyRole" list="partyRoleList"><econdition field-name="partyId"/></entity-find>
        <set field="roleTypeIdList" from="partyRoleList*.roleTypeId"/>
    </actions>
    <widgets>
        <container-box >
            <box-header title="客户基本信息"/>
            <box-toolbar>
<!--                <link url="findRequest" text="Requests"  parameter-map="[partyId:partyId]" link-type="anchor-button"  />-->
<!--                <link url="findOrder" text="销售订单"  parameter-map="[customerPartyId:partyId]" link-type="anchor-button" style="bg-blue-1 no-border text-grey"/>-->
                <render-mode>
                    <text type="qvt"><![CDATA[
                    <q-btn flat color="secondary" label="审批" icon="edit" size="xs"/>
                    <q-btn flat color="secondary" label="运单" icon="build" size="xs" />
                    ]]></text>
                </render-mode>
<!--                <link url="findShipment" text="运单"  parameter-map="[toPartyId:partyId]" link-type="anchor"/>-->
                <!--<link url="receivableStatement" text="Statement PDF" parameter-map="[toPartyId:partyId]" link-type="anchor"/>-->
                <container-dialog id="EditCustomerDialog" button-text="编辑" button-outline="false" button-flat="true" button-size="xs" type="secondary">
                    <section-include name="EditPartySection" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty.xml"/>
                </container-dialog>
                <dynamic-dialog id="FindDuplicatesDialog" button-text="Find Duplicates" transition="FindDuplicates" width="960"
                                button-outline="false" button-flat="true" button-size="xs" type="secondary"/>
            </box-toolbar>
            <box-body>
                <form-single name="CustomerViewForm" map="party">
                    <field name="hasDuplicates">
                        <default-field>
                            <section-include name="HasDuplicatesSection" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty.xml"/>
                        </default-field>
                    </field>
                    <field name="pseudoId"><default-field title="客户ID"><display/></default-field></field>
                    <field name="organizationName"><default-field title="客户名称"><display/></default-field></field>

                    <field name="disabled"><default-field title="禁用状态"><display/></default-field></field>
                    <field name="gatewayCimId"><default-field title="网关ID"><display/></default-field></field>
                    <field name="externalId"><default-field title="外部ID"><display/></default-field></field>
                    <field name="ownerPartyId"><default-field title="拥有者"><display/></default-field></field>
                    <field name="comments"><default-field title="备注"><text-area rows="1" cols="120" read-only="true"/></default-field></field>
                    <field name="shippingInstructions"><default-field title="配送说明"><text-area rows="1" cols="120" read-only="true"/></default-field></field>

                    <field-layout>
                        <field-ref name="hasDuplicates"/>

                        <field-col-row>
                            <field-col md="3"><field-ref name="pseudoId"/></field-col>
                            <field-col md="3"><field-ref name="organizationName"/></field-col>
                            <field-col md="3"><field-ref name="externalId"/></field-col>
                            <field-col md="3"><field-ref name="gatewayCimId"/></field-col>
                        </field-col-row>
                        <field-col-row>
                            <field-col md="3"><field-ref name="ownerPartyId"/></field-col>
                            <field-col md="3"><field-ref name="disabled"/></field-col>
                        </field-col-row>

                        <field-ref name="comments"/>
                        <field-ref name="shippingInstructions"/>
                    </field-layout>
                </form-single>
            </box-body>
        </container-box>
        <section name="NotesSection"><actions>
            <entity-find entity-name="mantle.party.PartyNote" list="partyNoteList">
                <econdition field-name="partyId"/><order-by field-name="-noteDate"/></entity-find>
        </actions><widgets>
            <container-box initial="closed"><box-header title="沟通记录"/><box-toolbar>
                <container-dialog id="NewNoteDialog" button-text="添加记录" button-outline="false" button-flat="true" button-size="xs" type="secondary">
                    <form-single name="NewNoteForm" transition="createPartyNote">
                        <field name="partyId"><default-field><hidden/></default-field></field>
                        <field name="noteText"><default-field title="Note"><text-area cols="60" rows="6"/></default-field></field>
                        <field name="submitButton"><default-field title="Add Note"><submit/></default-field></field>
                    </form-single>
                </container-dialog>
            </box-toolbar><box-body>
                <label text="无内容" condition="!partyNoteList" style="text-grey"/>
                <section-iterate name="NoteIterateSection" list="partyNoteList" entry="partyNote"><actions>
                    <entity-find-one entity-name="mantle.party.PersonWithUserAccount" value-field="paua">
                        <field-map field-name="userId" from="partyNote.userId"/></entity-find-one>
                </actions><widgets>
                    <label text="By ${paua?.firstName?:''} ${paua?.lastName?:''} (${paua?.username ?: partyNote.userId}) at ${ec.l10n.format(partyNote.noteDate, 'yyyy-MM-dd HH:mm')}" style="text-grey"/>
                    <section name="UpdateNoteSection" condition="partyNote.userId == ec.user.userId || ec.user.isInGroup('ADMIN')"><widgets>
                        <container-dialog id="UpdateNoteContainer" button-text="" button-outline="false" button-flat="true" button-size="xs" icon="edit" type="secondary">
                            <form-single name="UpdateNoteForm" transition="updatePartyNote" map="partyNote">
                                <field name="partyId"><default-field><hidden/></default-field></field>
                                <field name="noteDate"><default-field><hidden/></default-field></field>
                                <field name="noteText"><default-field title="Note"><text-area cols="60" rows="6"/></default-field></field>
                                <field name="submitButton"><default-field title="Update"><submit/></default-field></field>
                            </form-single>
                        </container-dialog>
                    </widgets></section>
                    <label text="${partyNote.noteText}" type="p"/>
                </widgets></section-iterate>
            </box-body></container-box>
        </widgets></section>

        <container-box type="info" initial="closed">
            <box-header title="联系方式"/>
            <box-toolbar><container-dialog id="Xxx" button-text="新建联系方式" type="secondary" button-outline="false" button-flat="true" button-size="xs" ></container-dialog> </box-toolbar>
        </container-box>
        <section name="ContentSection"><actions>
            <entity-find entity-name="mantle.party.PartyContent" list="contentList">
                <econdition field-name="partyId"/><order-by field-name="-contentDate"/></entity-find>
        </actions><widgets>
            <container-box initial="closed"><box-header title="附件"/><box-toolbar>
                <container-dialog id="NewContentDialog" button-text="添加附件"  button-outline="false" button-flat="true" button-size="xs" type="secondary">
                    <form-single name="NewContentForm" transition="createContent">
                        <field name="partyId"><default-field><hidden/></default-field></field>
                        <field name="partyContentTypeEnumId"><default-field title="Content Type">
                            <widget-template-include location="component://webroot/template/screen/BasicWidgetTemplates.xml#enumDropDown">
                                <set field="enumTypeId" value="PartyContentType"/><set field="allowEmpty" value="true"/></widget-template-include>
                        </default-field></field>
                        <field name="contentFile"><default-field><file/></default-field></field>
                        <field name="description"><default-field><text-line size="60"/></default-field></field>
                        <field name="submitButton"><default-field title="Add"><submit/></default-field></field>
                    </form-single>
                </container-dialog>
            </box-toolbar><box-body>
                <section-iterate name="ContentIterateSection" list="contentList" entry="content"><actions>
                    <entity-find-one entity-name="mantle.party.PersonWithUserAccount" value-field="paua">
                        <field-map field-name="userId" from="content.userId"/></entity-find-one>
                    <entity-find-one entity-name="moqui.basic.Enumeration" value-field="contentTypeEnum">
                        <field-map field-name="enumId" from="content.partyContentTypeEnumId"/></entity-find-one>
                </actions><widgets>
                    <container>
                        <container><label text="${contentTypeEnum?.description?:'No Type'}" type="strong"/></container>
                        <link url="downloadContent" condition="content.contentLocation"
                              parameter-map="[partyContentId:content.partyContentId]"
                              text="Download ${content.contentLocation.substring(content.contentLocation.lastIndexOf('/')+1)}"/>
                        <container-dialog id="UpdateContentContainer" button-text="Edit Content">
                            <form-single name="UpdateContentForm" transition="updateContent" map="content">
                                <field name="partyContentId"><default-field><hidden/></default-field></field>
                                <field name="partyId"><default-field><hidden/></default-field></field>
                                <field name="partyContentTypeEnumId"><default-field title="Content Type">
                                    <widget-template-include location="component://webroot/template/screen/BasicWidgetTemplates.xml#enumDropDown">
                                        <set field="enumTypeId" value="PartyContentType"/><set field="allowEmpty" value="true"/></widget-template-include>
                                </default-field></field>
                                <field name="contentFile"><default-field><file/></default-field></field>
                                <field name="description"><default-field><text-line size="60"/></default-field></field>
                                <field name="submitButton"><default-field title="Update"><submit/></default-field></field>
                            </form-single>
                        </container-dialog>
                        <container><label condition="paua" text="By ${ec.resource.expand('UsernameTemplate','',paua+[userId:content.userId])} at ${ec.l10n.format(content.contentDate, 'yyyy-MM-dd HH:mm')}"/></container>
                        <label text="${content.description ?: 'No Description'}" type="p"/>
                    </container>
                </widgets></section-iterate>
            </box-body></container-box>
        </widgets></section>
<!--        <section-include name="ContentSection" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty.xml"/>-->
<!--        <section-include name="SalesAccountContactSection" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty.xml"/>-->

    </widgets>
</screen>
